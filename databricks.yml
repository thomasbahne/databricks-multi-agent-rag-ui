bundle:
  name: multi-agent-rag-ui

variables:
  catalog:
    description: "Unity Catalog name"
  schema:
    description: "Schema name for RAG agents"
  warehouse_id:
    description: "SQL warehouse ID for app queries"

resources:
  jobs:
    rag_data_pipeline:
      name: "rag-data-pipeline-${bundle.target}"
      tasks:
        - task_key: parse_pdfs
          notebook_task:
            notebook_path: ./data_prep/01_parse_pdfs.ipynb
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
          environment_key: default

        - task_key: create_indexes
          depends_on:
            - task_key: parse_pdfs
          notebook_task:
            notebook_path: ./data_prep/02_create_indexes.ipynb
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
          environment_key: default

        - task_key: deploy_agents
          depends_on:
            - task_key: create_indexes
          notebook_task:
            notebook_path: ./agents/deploy_agents.ipynb
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
          environment_key: default

      environments:
        - environment_key: default
          spec:
            client: "1"

  apps:
    rag_chat:
      name: "multi-agent-rag-chat"
      description: "Multi-agent RAG chat interface"
      source_code_path: ./src/chat_app
      config:
        command:
          - python
          - app.py
        env:
          - name: DATABRICKS_CATALOG
            value: ${var.catalog}
          - name: DATABRICKS_SCHEMA
            value: ${var.schema}
          - name: DATABRICKS_WAREHOUSE_ID
            value: ${var.warehouse_id}
      resources:
        - name: serving-endpoint
          serving_endpoint:
            name: "*-rag"
            permission: CAN_QUERY

targets:
  dev:
    mode: development
    default: true
    workspace:
      host: ${DATABRICKS_HOST}
  prod:
    mode: production
    workspace:
      host: ${DATABRICKS_HOST}
